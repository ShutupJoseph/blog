# 2.éƒ¨ç½²Kubernetesé›†ç¾¤

åœ¨å¯¹å®¹å™¨è¿è¡Œæ—¶å’Œ K8s æœ‰äº†ä¸€ä¸ªæ•´ä½“ä¸Šçš„è®¤è¯†åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦æ¥æ­å»ºä¸€ä¸ª K8s é›†ç¾¤äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°†ä¼šä½¿ç”¨ Kubeadm å’Œ Kind ä¸¤ç§å·¥å…·æ¥æ­å»ºé›†ç¾¤ã€‚


## Kubeadm

![1669859400635.jpg](./img/KHpWumYNDl6Ild3W/1693830364301-b3b601bf-4145-4e25-80e0-5156d25a8888-842531.jpeg)

Kubeadm æ˜¯ä¸€ä¸ªå®‰è£… K8s é›†ç¾¤çš„å·¥å…·åŒ…ï¼Œå¯å¸®åŠ©ä½ ä»¥æ›´ç®€å•ã€åˆç†å®‰å…¨å’Œå¯æ‰©å±•çš„æ–¹å¼å¼•å¯¼æœ€ä½³å®è·µ Kubernetes ç¾¤é›†ã€‚å®ƒè¿˜æ”¯æŒä¸ºä½ ç®¡ç† Bootstrap Tokens å¹¶å‡çº§/é™çº§é›†ç¾¤ã€‚

Kubeadm çš„ç›®æ ‡æ˜¯å»ºç«‹ä¸€ä¸ªé€šè¿‡ Kubernetes ä¸€è‡´æ€§æµ‹è¯•çš„æœ€å°å¯è¡Œé›†ç¾¤ ï¼Œä½†ä¸ä¼šå®‰è£…å…¶ä»–åŠŸèƒ½æ’ä»¶ã€‚åœ¨è®¾è®¡ä¸Šå¹¶æœªå®‰è£…ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥éœ€è¦ç”¨æˆ·è‡ªè¡Œå®‰è£…ç¬¬ä¸‰æ–¹ç¬¦åˆ CNI çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼ˆå¦‚ flanalï¼Œcalico ç­‰ï¼‰ã€‚æ­¤å¤– Kubeadm å¯ä»¥åœ¨å¤šç§è®¾å¤‡ä¸Šè¿è¡Œï¼Œå¯ä»¥æ˜¯ Linux ç¬”è®°æœ¬ç”µè„‘ã€è™šæ‹Ÿæœºã€ç‰©ç†/äº‘æœåŠ¡å™¨æˆ– Raspberry Piï¼Œè¿™ä½¿å¾— Kubeadm éå¸¸é€‚åˆä¸ä¸åŒç§ç±»çš„é…ç½®ç³»ç»Ÿï¼ˆä¾‹å¦‚ Terraformï¼ŒAnsible ç­‰ï¼‰é›†æˆã€‚

Kubeadm åœ¨ 2018 å¹´ 12 æœˆ 3 æ—¥å‘å¸ƒçš„ [Kubernetes 1.13](https://kubernetes.io/blog/2018/12/03/kubernetes-1-13-release-announcement/) ç‰ˆæœ¬ä¸­å°±å·²ç»å®£å¸ƒ GA äº†ï¼Œæ‰€ä»¥å¯ä»¥æ”¯æŒç”Ÿäº§ç¯å¢ƒã€‚

ç°åœ¨æˆ‘ä»¬å°±æ¥ä½¿ç”¨ Kubeadm ä»å¤´æ­å»ºä¸€ä¸ªä½¿ç”¨ Containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„ K8s é›†ç¾¤ï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£…çš„æ˜¯æœ€æ–°ç¨³å®šç‰ˆ `v1.25.4` ç‰ˆæœ¬ã€‚


### ç¯å¢ƒå‡†å¤‡

3 ä¸ªèŠ‚ç‚¹ï¼Œéƒ½æ˜¯ Centos 7.6 ç³»ç»Ÿï¼Œå†…æ ¸ç‰ˆæœ¬ï¼š`3.10.0-1160.71.1.el7.x86_64`ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ·»åŠ  hosts ä¿¡æ¯ï¼š

```shell
â˜¸ âœ cat /etc/hosts
172.21.0.2 master
172.21.0.3 node1
172.21.0.4 node2
```

> èŠ‚ç‚¹çš„ hostname å¿…é¡»ä½¿ç”¨**æ ‡å‡†çš„ DNS å‘½å**ï¼Œå¦å¤–åƒä¸‡åˆ«ç”¨é»˜è®¤ `localhost` çš„ hostnameï¼Œä¼šå¯¼è‡´å„ç§é”™è¯¯å‡ºç°çš„ã€‚åœ¨ Kubernetes é¡¹ç›®é‡Œï¼Œæœºå™¨çš„åå­—ä»¥åŠä¸€åˆ‡å­˜å‚¨åœ¨ Etcd ä¸­çš„ API å¯¹è±¡ï¼Œéƒ½å¿…é¡»ä½¿ç”¨æ ‡å‡†çš„ DNS å‘½åï¼ˆRFC 1123ï¼‰ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤ `hostnamectl set-hostname xxx` æ¥ä¿®æ”¹ hostnameã€‚


ä¸‹é¢æ˜¯ä¸€äº›ç¯å¢ƒå‡†å¤‡å·¥ä½œï¼Œéœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹é…ç½®ã€‚

é¦–å…ˆç¦ç”¨é˜²ç«å¢™ï¼š

```shell
â˜¸ âœ systemctl stop firewalld
â˜¸ âœ systemctl disable firewalld
```

ç¦ç”¨ `SELINUX`ï¼š

```shell
â˜¸ âœ setenforce 0
# ä½¿ç”¨ä¸‹é¢å‘½ä»¤éªŒè¯æ˜¯å¦ç¦ç”¨æˆåŠŸ
â˜¸ âœ cat /etc/selinux/config
SELINUX=disabled
```

å¦‚æœä½¿ç”¨çš„æ˜¯äº‘æœåŠ¡å™¨ï¼Œæ¯”å¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼Œéœ€è¦é…ç½®å®‰å…¨ç»„ï¼Œæ”¾å¼€ç«¯å£ï¼Œå¦‚æœåªæ˜¯ä¸ºäº†æµ‹è¯•æ–¹ä¾¿å¯ä»¥ç›´æ¥å…¨éƒ¨æ”¾å¼€ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒåˆ™åªéœ€è¦æ”¾å¼€ K8s è¦æ˜¯ä½¿ç”¨åˆ°çš„ä¸€äº›ç«¯å£ï¼Œæ¯”å¦‚ 6443 ç­‰ç­‰ã€‚

![1669859976771.png](./img/KHpWumYNDl6Ild3W/1693830365717-cb680759-6640-423c-88fd-d5d29cc2028f-029375.png)

ç”±äºå¼€å¯å†…æ ¸ ipv4 è½¬å‘éœ€è¦åŠ è½½ `br_netfilter` æ¨¡å—ï¼Œæ‰€ä»¥åŠ è½½ä¸‹è¯¥æ¨¡å—ï¼š

```shell
â˜¸ âœ modprobe br_netfilter
```

æœ€å¥½å°†ä¸Šé¢çš„å‘½ä»¤è®¾ç½®æˆå¼€æœºå¯åŠ¨ï¼Œå› ä¸ºé‡å¯åæ¨¡å—å¤±æ•ˆï¼Œä¸‹é¢æ˜¯å¼€æœºè‡ªåŠ¨åŠ è½½æ¨¡å—çš„æ–¹å¼ï¼Œåœ¨ `etc/rc.d/rc.local` æ–‡ä»¶æœ«å°¾æ·»åŠ å¦‚ä¸‹è„šæœ¬å†…å®¹ï¼š

```shell
for file in /etc/sysconfig/modules/*.modules ; do
[ -x $file ] && $file
done
```

ç„¶ååœ¨ `/etc/sysconfig/modules/` ç›®å½•ä¸‹æ–°å»ºå¦‚ä¸‹æ–‡ä»¶ï¼š

```shell
â˜¸ âœ mkdir -p /etc/sysconfig/modules/
â˜¸ âœ vi /etc/sysconfig/modules/br_netfilter.modules
modprobe br_netfilter
```

å¢åŠ æƒé™ï¼š

```shell
â˜¸ âœ chmod 755 br_netfilter.modules
```

ç„¶åé‡å¯åï¼Œæ¨¡å—å°±å¯ä»¥è‡ªåŠ¨åŠ è½½äº†ï¼š

```shell
â˜¸ âœ lsmod |grep br_netfilter
br_netfilter           22256  0
bridge                151336  1 br_netfilter
```

ç„¶ååˆ›å»º `/etc/sysctl.d/k8s.conf` æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```shell
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
# ä¸‹é¢çš„å†…æ ¸å‚æ•°å¯ä»¥è§£å†³ipvsæ¨¡å¼ä¸‹é•¿è¿æ¥ç©ºé—²è¶…æ—¶çš„é—®é¢˜
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10
net.ipv4.tcp_keepalive_time = 600
```

![1669861003027.png](./img/KHpWumYNDl6Ild3W/1693830367709-85298453-6e70-462f-9438-9c4c35542c06-921107.png)

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä½¿ä¿®æ”¹ç”Ÿæ•ˆï¼š

```shell
â˜¸ âœ sysctl -p /etc/sysctl.d/k8s.conf
```

å®‰è£… ipvsï¼š

```shell
â˜¸ âœ cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
â˜¸ âœ chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4
```

ä¸Šé¢è„šæœ¬åˆ›å»ºäº† `/etc/sysconfig/modules/ipvs.modules` æ–‡ä»¶ï¼Œä¿è¯åœ¨èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½æ‰€éœ€æ¨¡å—ã€‚ä½¿ç”¨ `lsmod | grep -e ip_vs -e nf_conntrack_ipv4` å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å·²ç»æ­£ç¡®åŠ è½½æ‰€éœ€çš„å†…æ ¸æ¨¡å—ã€‚

æ¥ä¸‹æ¥è¿˜éœ€è¦ç¡®ä¿å„ä¸ªèŠ‚ç‚¹ä¸Šå·²ç»å®‰è£…äº† ipset è½¯ä»¶åŒ…ï¼Œä¸ºäº†ä¾¿äºæŸ¥çœ‹ ipvs çš„ä»£ç†è§„åˆ™ï¼Œæœ€å¥½å®‰è£…ä¸€ä¸‹ç®¡ç†å·¥å…· ipvsadmï¼š

```shell
â˜¸ âœ yum install ipset
â˜¸ âœ yum install ipvsadm
```

ç„¶åè®°å¾—ä¸€å®šè¦åŒæ­¥æœåŠ¡å™¨æ—¶é—´ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `chrony` æ¥è¿›è¡ŒåŒæ­¥ï¼Œå…¶ä»–å·¥å…·ä¹Ÿå¯ä»¥ï¼š

```shell
â˜¸ âœ yum install chrony -y
â˜¸ âœ systemctl enable chronyd
â˜¸ âœ systemctl start chronyd
â˜¸ âœ chronyc sources
210 Number of sources = 4
MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
^? time.cloudflare.com           3   6     3     1  -2328us[-2328us] +/-   87ms
^? 119.28.183.184                2   6     3     1  -3438us[-3438us] +/-   75ms
^? ip-64-111-99-224.nodes.d>     0   6     0     -     +0ns[   +0ns] +/-    0ns
^? time.cloudflare.com           3   6     3     0  -6207us[-6207us] +/-   92ms
â˜¸ âœ date
Thu Dec  1 10:20:51 CST 2022
```

å…³é—­ swap åˆ†åŒºï¼š

```shell
â˜¸ âœ swapoff -a
```

ä¿®æ”¹ `/etc/fstab` æ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ SWAP çš„è‡ªåŠ¨æŒ‚è½½ï¼Œä½¿ç”¨ `free -m` ç¡®è®¤ swap å·²ç»å…³é—­ã€‚swappiness å‚æ•°è°ƒæ•´ï¼Œä¿®æ”¹ `/etc/sysctl.d/k8s.conf` æ·»åŠ ä¸‹é¢ä¸€è¡Œï¼š

```shell
vm.swappiness=0
```

æ‰§è¡Œ `sysctl -p /etc/sysctl.d/k8s.conf` ä½¿ä¿®æ”¹ç”Ÿæ•ˆã€‚

å½“ç„¶å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¿˜å¯ä»¥å…ˆå¯¹å†…æ ¸å‚æ•°è¿›è¡Œç»Ÿä¸€çš„è°ƒä¼˜ã€‚


### å®‰è£… Containerd

æ¥ä¸‹æ¥éœ€è¦å®‰è£… Containerd å®¹å™¨è¿è¡Œæ—¶ã€‚

> å¦‚æœåœ¨å®‰è£…é›†ç¾¤çš„è¿‡ç¨‹å‡ºç°äº†å®¹å™¨è¿è¡Œæ—¶çš„é—®é¢˜ï¼Œå¯åŠ¨ä¸èµ·æ¥ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ `yum install containerd.io` æ¥å®‰è£… Containerdã€‚


é¦–å…ˆéœ€è¦åœ¨èŠ‚ç‚¹ä¸Šå®‰è£… `seccomp` ä¾èµ–ï¼Œè¿™ä¸€æ­¥å¾ˆé‡è¦ï¼š

```shell
â˜¸ âœ rpm -qa |grep libseccomp
libseccomp-2.3.1-4.el7.x86_64
# å¦‚æœæ²¡æœ‰å®‰è£… libseccomp åŒ…åˆ™å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…ä¾èµ–
â˜¸ âœ wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libseccomp-2.3.1-4.el7.x86_64.rpm
â˜¸ âœ yum install libseccomp-2.3.1-4.el7.x86_64.rpm -y
```

ç”±äº Containerd éœ€è¦ä¾èµ–åº•å±‚çš„ runc å·¥å…·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦å…ˆå®‰è£… runcï¼Œä¸è¿‡ Containerd æä¾›äº†ä¸€ä¸ªåŒ…å«ç›¸å…³ä¾èµ–çš„å‹ç¼©åŒ… `cri-containerd-cni-${VERSION}.${OS}-${ARCH}.tar.gz`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªåŒ…æ¥è¿›è¡Œå®‰è£…ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨è¯¥å®‰è£…åŒ…ï¼Œä¸ç„¶å¯èƒ½å› ä¸º runc ç‰ˆæœ¬é—®é¢˜å¯¼è‡´ä¸å…¼å®¹ã€‚

é¦–å…ˆä» [release é¡µé¢](https://github.com/containerd/containerd/releases)ä¸‹è½½æœ€æ–°çš„ `1.6.10` ç‰ˆæœ¬çš„å‹ç¼©åŒ…ï¼š

```shell
â˜¸ âœ wget https://github.com/containerd/containerd/releases/download/v1.6.10/cri-containerd-1.6.10-linux-amd64.tar.gz
# å¦‚æœæœ‰é™åˆ¶ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢æˆä¸‹é¢çš„ URL åŠ é€Ÿä¸‹è½½
# wget https://ghdl.feizhuqwq.cf/https://github.com/containerd/containerd/releases/download/v1.6.10/cri-containerd-1.6.10-linux-amd64.tar.gz
```

ç›´æ¥å°†å‹ç¼©åŒ…è§£å‹åˆ°ç³»ç»Ÿçš„å„ä¸ªç›®å½•ä¸­ï¼š

```shell
â˜¸ âœ tar -C / -xzf cri-containerd-1.6.10-linux-amd64.tar.gz
```

è®°å¾—å°† `/usr/local/bin` å’Œ `/usr/local/sbin` è¿½åŠ åˆ° `PATH` ç¯å¢ƒå˜é‡ä¸­ï¼š

```shell
â˜¸ âœ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
â˜¸ âœ containerd -v
containerd github.com/containerd/containerd v1.6.10 770bd0108c32f3fb5c73ae1264f7e503fe7b2661
â˜¸ âœ runc -h
runc: symbol lookup error: runc: undefined symbol: seccomp_notify_respond
```

å¯ä»¥æ­£å¸¸æ‰§è¡Œ `containerd -v` å‘½ä»¤è¯æ˜ Containerd å®‰è£…æˆåŠŸäº†ï¼Œä½†æ˜¯æ‰§è¡Œ `runc -h` å‘½ä»¤çš„æ—¶å€™å´å‡ºç°äº†ç±»ä¼¼ `runc: undefined symbol: seccomp_notify_respond` çš„é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å½“å‰ç³»ç»Ÿé»˜è®¤å®‰è£…çš„ `libseccomp` æ˜¯ `2.3.1` ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬å·²ç»ä¸èƒ½æ»¡è¶³æˆ‘ä»¬è¿™é‡Œçš„ `v1.6.10` ç‰ˆæœ¬çš„ Containerd äº†ï¼ˆä» `1.5.7` ç‰ˆæœ¬å¼€å§‹å°±ä¸å…¼å®¹äº†ï¼‰ï¼Œéœ€è¦ 2.4 ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡æ–°å®‰è£…ä¸€ä¸ªé«˜ç‰ˆæœ¬çš„ `libseccomp`ã€‚

```bash
â˜¸ âœ rpm -qa | grep libseccomp
libseccomp-2.3.1-4.el7.x86_64
# ä¸‹è½½é«˜äº 2.4 ä»¥ä¸Šçš„åŒ…
â˜¸ âœ wget http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm
â˜¸ âœ rpm -ivh libseccomp-2.5.1-1.el8.x86_64.rpm
â˜¸ âœ rpm -qa | grep libseccomp
libseccomp-2.5.1-1.el8.x86_64
```

ç°åœ¨ `runc` å‘½ä»¤å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼š

```bash
â˜¸ âœ runc -v
runc version 1.1.4
commit: v1.1.4-0-g5fd4c4d1
spec: 1.0.2-dev
go: go1.18.8
libseccomp: 2.5.1
```

Containerd çš„é»˜è®¤é…ç½®æ–‡ä»¶ä¸º `/etc/containerd/config.toml`ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„é…ç½®ï¼š

```shell
â˜¸ âœ mkdir -p /etc/containerd
â˜¸ âœ containerd config default > /etc/containerd/config.toml
```

å¯¹äºä½¿ç”¨ systemd ä½œä¸º init system çš„ Linux çš„å‘è¡Œç‰ˆï¼Œä½¿ç”¨ `systemd` ä½œä¸ºå®¹å™¨çš„ `cgroup driver` å¯ä»¥ç¡®ä¿èŠ‚ç‚¹åœ¨èµ„æºç´§å¼ çš„æƒ…å†µæ›´åŠ ç¨³å®šï¼Œæ‰€ä»¥æ¨èå°† containerd çš„ cgroup driver é…ç½®ä¸º systemdã€‚

ä¿®æ”¹å‰é¢ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ `/etc/containerd/config.toml`ï¼Œåœ¨ `plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options` é…ç½®å—ä¸‹é¢å°† `SystemdCgroup` è®¾ç½®ä¸º `true`ï¼š

```toml
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
  ...
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
    SystemdCgroup = true
    ....
```

ç„¶åå†ä¸ºé•œåƒä»“åº“é…ç½®ä¸€ä¸ªåŠ é€Ÿå™¨ï¼Œéœ€è¦åœ¨ cri é…ç½®å—ä¸‹é¢çš„ `registry` é…ç½®å—ä¸‹é¢è¿›è¡Œé…ç½® `registry.mirrors`ï¼š

```toml
[plugins."io.containerd.grpc.v1.cri"]
  ...
  # sandbox_image = "registry.k8s.io/pause:3.6"
  sandbox_image = "registry.aliyuncs.com/k8sxio/pause:3.8"
  ...
  [plugins."io.containerd.grpc.v1.cri".registry]
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
        endpoint = ["https://bqr1dr1n.mirror.aliyuncs.com"]
```

> ç°åœ¨ç¤¾åŒºå·²ç»å°† K8s é»˜è®¤çš„é•œåƒä»“åº“ä» `k8s.gcr.io` è¿ç§»åˆ°äº† `registry.k8s.io`ï¼Œä¸è¿‡å›½å†…æ­£å¸¸æƒ…å†µä¸‹è¿˜æ˜¯ä¸èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„èŠ‚ç‚¹ä¸èƒ½æ­£å¸¸è·å– `registry.k8s.io` çš„é•œåƒï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨ä¸Šé¢é‡æ–°é…ç½® `sandbox_image` é•œåƒï¼ŒContainerd æ¨¡å¼ä¸‹ç›´æ¥é€šè¿‡ kubelet è¦†ç›–è¯¥é•œåƒä¸ä¼šç”Ÿæ•ˆï¼š`Warning: For remote container runtime, --pod-infra-container-image is ignored in kubelet, which should be set in that remote runtime instead`ã€‚


ç”±äºä¸Šé¢æˆ‘ä»¬ä¸‹è½½çš„ Containerd å‹ç¼©åŒ…ä¸­åŒ…å«ä¸€ä¸ª `etc/systemd/system/containerd.service` çš„æ–‡ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ systemd æ¥é…ç½® Containerd ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹è¿è¡Œäº†ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨ Containerd äº†ï¼Œç›´æ¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ï¼š

```shell
â˜¸ âœ systemctl daemon-reload
â˜¸ âœ systemctl enable containerd --now
```

å¯åŠ¨å®Œæˆåå°±å¯ä»¥ä½¿ç”¨ Containerd çš„ CLI å·¥å…· `ctr` å’Œ `crictl` äº†ï¼Œæ¯”å¦‚æŸ¥çœ‹ç‰ˆæœ¬ï¼š

```shell
â˜¸ âœ ctr version
Client:
  Version:  v1.6.10
  Revision: 770bd0108c32f3fb5c73ae1264f7e503fe7b2661
  Go version: go1.18.8

Server:
  Version:  v1.6.10
  Revision: 770bd0108c32f3fb5c73ae1264f7e503fe7b2661
  UUID: 9b89c1b6-27d0-434b-8c71-243c7af750c5
â˜¸ âœ crictl version
Version:  0.1.0
RuntimeName:  containerd
RuntimeVersion:  v1.6.10
RuntimeApiVersion:  v1
```


### åˆå§‹åŒ–é›†ç¾¤

ä¸Šé¢çš„ç›¸å…³ç¯å¢ƒé…ç½®å®Œæˆåï¼Œæ¥ç€æˆ‘ä»¬å°±å¯ä»¥æ¥å®‰è£… Kubeadm äº†ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯é€šè¿‡æŒ‡å®š yum æºçš„æ–¹å¼æ¥è¿›è¡Œå®‰è£…çš„ï¼š

```shell
â˜¸ âœ cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
```

å½“ç„¶äº†ï¼Œä¸Šé¢çš„ yum æºæ˜¯éœ€è¦ç§‘å­¦ä¸Šç½‘çš„ï¼Œå¦‚æœä¸èƒ½ç§‘å­¦ä¸Šç½‘çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çš„æºè¿›è¡Œå®‰è£…ï¼š

```shell
â˜¸ âœ cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

ç„¶åå®‰è£… kubeadmã€kubeletã€kubectlï¼š

```shell
# --disableexcludes ç¦æ‰é™¤äº†kubernetesä¹‹å¤–çš„åˆ«çš„ä»“åº“
â˜¸ âœ yum makecache fast
â˜¸ âœ yum install -y kubelet-1.25.4 kubeadm-1.25.4 kubectl-1.25.4 --disableexcludes=kubernetes
â˜¸ âœ kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"25", GitVersion:"v1.25.4", GitCommit:"872a965c6c6526caa949f0c6ac028ef7aff3fb78", GitTreeState:"clean", BuildDate:"2022-11-09T13:35:06Z", GoVersion:"go1.19.3", Compiler:"gc", Platform:"linux/amd64"}
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œå®‰è£…çš„æ˜¯ `v1.25.4` ç‰ˆæœ¬ï¼Œç„¶åå°† master èŠ‚ç‚¹çš„ kubelet è®¾ç½®æˆå¼€æœºå¯åŠ¨ï¼š

```shell
â˜¸ âœ systemctl enable --now kubelet
```

åˆ°è¿™é‡Œä¸ºæ­¢**ä¸Šé¢æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œé…ç½®**ï¼Œåœ¨äº‘ç¯å¢ƒä¸Šé¢çš„è¯æˆ‘ä»¬å¯ä»¥å°†å½“å‰ç¯å¢ƒç›´æ¥åšæˆä¸€ä¸ªé•œåƒï¼Œç„¶ååˆ›å»ºæ–°èŠ‚ç‚¹çš„æ—¶å€™ç›´æ¥ä½¿ç”¨è¯¥é•œåƒå³å¯ï¼Œè¿™æ ·å¯ä»¥é¿å…é‡å¤çš„å·¥ä½œã€‚

![1669863778102.png](./img/KHpWumYNDl6Ild3W/1693831211590-2994ca34-7717-4412-9d79-358309962570-440916.png)

å½“æˆ‘ä»¬æ‰§è¡Œ `kubelet --help` å‘½ä»¤çš„æ—¶å€™å¯ä»¥çœ‹åˆ°åŸæ¥å¤§éƒ¨åˆ†å‘½ä»¤è¡Œå‚æ•°éƒ½è¢« `DEPRECATED`äº†ï¼Œè¿™æ˜¯å› ä¸ºå®˜æ–¹æ¨èæˆ‘ä»¬ä½¿ç”¨ `--config` æ¥æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šåŸæ¥è¿™äº›å‚æ•°çš„é…ç½®ï¼Œå¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£ [Set Kubelet parameters via a config file](https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/) äº†è§£æ›´å¤šç›¸å…³ä¿¡æ¯ï¼Œè¿™æ · Kubernetes å°±å¯ä»¥æ”¯æŒåŠ¨æ€ Kubelet é…ç½®ï¼ˆDynamic Kubelet Configurationï¼‰äº†ï¼Œå‚è€ƒ [Reconfigure a Nodeâ€™s Kubelet in a Live Cluster](https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/)ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åœ¨ master èŠ‚ç‚¹ä¸Šè¾“å‡ºé›†ç¾¤åˆå§‹åŒ–é»˜è®¤ä½¿ç”¨çš„é…ç½®ï¼š

```shell
â˜¸ âœ kubeadm config print init-defaults --component-configs KubeletConfiguration > kubeadm.yaml
```

ç„¶åæ ¹æ®æˆ‘ä»¬è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹é…ç½®ï¼Œæ¯”å¦‚ä¿®æ”¹ `imageRepository` æŒ‡å®šé›†ç¾¤åˆå§‹åŒ–æ—¶æ‹‰å– Kubernetes æ‰€éœ€é•œåƒçš„åœ°å€ï¼Œkube-proxy çš„æ¨¡å¼ä¸º ipvsï¼Œå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿™é‡Œå‡†å¤‡å®‰è£… flannel ç½‘ç»œæ’ä»¶çš„ï¼Œéœ€è¦å°† `networking.podSubnet` è®¾ç½®ä¸º `10.244.0.0/16`ï¼š

```yaml
# kubeadm.yaml
apiVersion: kubeadm.k8s.io/v1beta3
bootstrapTokens:
  - groups:
      - system:bootstrappers:kubeadm:default-node-token
    token: abcdef.0123456789abcdef
    ttl: 24h0m0s
    usages:
      - signing
      - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 172.21.0.2
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock
  imagePullPolicy: IfNotPresent
  name: master
  taints:
    - effect: "NoSchedule"
      key: "node-role.kubernetes.io/master"
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta3
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns: {}
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.aliyuncs.com/k8sxio
kind: ClusterConfiguration
kubernetesVersion: 1.25.4
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.96.0.0/12
  podSubnet: 10.244.0.0/16 # æŒ‡å®š pod å­ç½‘
scheduler: {}
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs # kube-proxy æ¨¡å¼
---
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 0s
    cacheUnauthorizedTTL: 0s
cgroupDriver: systemd
clusterDNS:
  - 10.96.0.10
clusterDomain: cluster.local
cpuManagerReconcilePeriod: 0s
evictionPressureTransitionPeriod: 0s
fileCheckFrequency: 0s
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 0s
imageMinimumGCAge: 0s
kind: KubeletConfiguration
logging:
  flushFrequency: 0
  options:
    json:
      infoBufferSize: "0"
  verbosity: 0
memorySwap: {}
nodeStatusReportFrequency: 0s
nodeStatusUpdateFrequency: 0s
rotateCertificates: true
runtimeRequestTimeout: 0s
shutdownGracePeriod: 0s
shutdownGracePeriodCriticalPods: 0s
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 0s
syncFrequency: 0s
volumeStatsAggPeriod: 0s
```

> å¯¹äºä¸Šé¢çš„èµ„æºæ¸…å•çš„æ–‡æ¡£æ¯”è¾ƒæ‚ï¼Œè¦æƒ³å®Œæ•´äº†è§£ä¸Šé¢çš„èµ„æºå¯¹è±¡å¯¹åº”çš„å±æ€§ï¼Œå¯ä»¥æŸ¥çœ‹å¯¹åº”çš„ godoc æ–‡æ¡£ï¼Œåœ°å€:[https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta3](https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta3)ã€‚


åœ¨å¼€å§‹åˆå§‹åŒ–é›†ç¾¤ä¹‹å‰å¯ä»¥ä½¿ç”¨ `kubeadm config images pull --config kubeadm.yaml` é¢„å…ˆåœ¨å„ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä¸Šæ‹‰å–æ‰€ k8s éœ€è¦çš„å®¹å™¨é•œåƒã€‚

é…ç½®æ–‡ä»¶å‡†å¤‡å¥½è¿‡åï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å…ˆå°†ç›¸å…³é•œåƒ pull ä¸‹é¢ï¼š

```shell
â˜¸ âœ kubeadm config images pull --config kubeadm.yaml
[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-apiserver:v1.25.4
[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-controller-manager:v1.25.4
[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-scheduler:v1.25.4
[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-proxy:v1.25.4
[config/images] Pulled registry.aliyuncs.com/k8sxio/pause:3.8
[config/images] Pulled registry.aliyuncs.com/k8sxio/etcd:3.5.5-0
failed to pull image "registry.aliyuncs.com/k8sxio/coredns:v1.9.3": output: E1201 11:16:23.106965   12850 remote_image.go:238] "PullImage from image service failed" err="rpc error: code = NotFound desc = failed to pull and unpack image \"registry.aliyuncs.com/k8sxio/coredns:v1.9.3\": failed to resolve reference \"registry.aliyuncs.com/k8sxio/coredns:v1.9.3\": registry.aliyuncs.com/k8sxio/coredns:v1.9.3: not found" image="registry.aliyuncs.com/k8sxio/coredns:v1.9.3"
time="2022-12-01T11:16:23+08:00" level=fatal msg="pulling image: rpc error: code = NotFound desc = failed to pull and unpack image \"registry.aliyuncs.com/k8sxio/coredns:v1.9.3\": failed to resolve reference \"registry.aliyuncs.com/k8sxio/coredns:v1.9.3\": registry.aliyuncs.com/k8sxio/coredns:v1.9.3: not found"
, error: exit status 1
To see the stack trace of this error execute with --v=5 or higher
```

ä¸Šé¢åœ¨æ‹‰å– `coredns` é•œåƒçš„æ—¶å€™å‡ºé”™äº†ï¼Œæ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªé•œåƒï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ pull è¯¥é•œåƒï¼Œç„¶åé‡æ–° tag ä¸‹é•œåƒåœ°å€å³å¯ï¼š

```shell
â˜¸ âœ ctr -n k8s.io i pull docker.io/coredns/coredns:1.9.3
docker.io/coredns/coredns:1.9.3:                                                  resolved       |++++++++++++++++++++++++++++++++++++++|
index-sha256:8e352a029d304ca7431c6507b56800636c321cb52289686a581ab70aaa8a2e2a:    done           |++++++++++++++++++++++++++++++++++++++|
manifest-sha256:bdb36ee882c13135669cfc2bb91c808a33926ad1a411fee07bd2dc344bb8f782: done           |++++++++++++++++++++++++++++++++++++++|
config-sha256:5185b96f0becf59032b8e3646e99f84d9655dff3ac9e2605e0dc77f9c441ae4a:   done           |++++++++++++++++++++++++++++++++++++++|
layer-sha256:d92bdee797857f997be3c92988a15c196893cbbd6d5db2aadcdffd2a98475d2d:    done           |++++++++++++++++++++++++++++++++++++++|
layer-sha256:f2401d57212f95ea8e82ff8728f4f99ef02d4b39459837244d1b049c5d43de43:    done           |++++++++++++++++++++++++++++++++++++++|
elapsed: 18.7s                                                                    total:  13.1 M (718.5 KiB/s)
unpacking linux/amd64 sha256:8e352a029d304ca7431c6507b56800636c321cb52289686a581ab70aaa8a2e2a...
done: 567.56858ms
â˜¸ âœ ctr -n k8s.io i tag docker.io/coredns/coredns:1.9.3 registry.aliyuncs.com/k8sxio/coredns:v1.9.3
```

> æ³¨æ„è¿™ä¸€æ­¥å…¶å®åº”è¯¥åœ¨ node èŠ‚ç‚¹ä¸Šå»æ“ä½œã€‚


ç„¶åå°±å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„é…ç½®æ–‡ä»¶åœ¨ master èŠ‚ç‚¹ä¸Šè¿›è¡Œåˆå§‹åŒ–ï¼š

```shell
â˜¸ âœ kubeadm init --config kubeadm.yaml
[init] Using Kubernetes version: v1.25.4
[preflight] Running pre-flight checks
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'
[certs] Using certificateDir folder "/etc/kubernetes/pki"
[certs] Generating "ca" certificate and key
[certs] Generating "apiserver" certificate and key
[certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master] and IPs [10.96.0.1 172.21.0.2]
[certs] Generating "apiserver-kubelet-client" certificate and key
[certs] Generating "front-proxy-ca" certificate and key
[certs] Generating "front-proxy-client" certificate and key
[certs] Generating "etcd/ca" certificate and key
[certs] Generating "etcd/server" certificate and key
[certs] etcd/server serving cert is signed for DNS names [localhost master] and IPs [172.21.0.2 127.0.0.1 ::1]
[certs] Generating "etcd/peer" certificate and key
[certs] etcd/peer serving cert is signed for DNS names [localhost master] and IPs [172.21.0.2 127.0.0.1 ::1]
[certs] Generating "etcd/healthcheck-client" certificate and key
[certs] Generating "apiserver-etcd-client" certificate and key
[certs] Generating "sa" key and public key
[kubeconfig] Using kubeconfig folder "/etc/kubernetes"
[kubeconfig] Writing "admin.conf" kubeconfig file
[kubeconfig] Writing "kubelet.conf" kubeconfig file
[kubeconfig] Writing "controller-manager.conf" kubeconfig file
[kubeconfig] Writing "scheduler.conf" kubeconfig file
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Starting the kubelet
[control-plane] Using manifest folder "/etc/kubernetes/manifests"
[control-plane] Creating static Pod manifest for "kube-apiserver"
[control-plane] Creating static Pod manifest for "kube-controller-manager"
[control-plane] Creating static Pod manifest for "kube-scheduler"
[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s
[apiclient] All control plane components are healthy after 6.003035 seconds
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config" in namespace kube-system with the configuration for the kubelets in the cluster
[upload-certs] Skipping phase. Please see --upload-certs
[mark-control-plane] Marking the node master as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
[mark-control-plane] Marking the node master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
[bootstrap-token] Using token: abcdef.0123456789abcdef
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes
[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 172.21.0.2:6443 --token abcdef.0123456789abcdef \
        --discovery-token-ca-cert-hash sha256:fc6f8c628bb51ae4cd228aefea957ca0be06188644e8bef992bbb3a9ce40fd5a
```

æ ¹æ®å®‰è£…æç¤ºæ‹·è´ kubeconfig æ–‡ä»¶ï¼š

```shell
â˜¸ âœ mkdir -p $HOME/.kube
â˜¸ âœ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
â˜¸ âœ sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

ç„¶åå¯ä»¥ä½¿ç”¨ kubectl å‘½ä»¤æŸ¥çœ‹ master èŠ‚ç‚¹æ˜¯å¦å·²ç»åˆå§‹åŒ–æˆåŠŸäº†ï¼š

```shell
â˜¸ âœ kubectl get nodes
NAME     STATUS     ROLES           AGE    VERSION
master   NotReady   control-plane   104s   v1.25.4
```

ç°åœ¨èŠ‚ç‚¹è¿˜å¤„äº `NotReady` çŠ¶æ€ï¼Œæ˜¯å› ä¸ºè¿˜æ²¡æœ‰å®‰è£… CNI æ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ·»åŠ ä¸€ä¸ª Node èŠ‚ç‚¹ï¼Œå†éƒ¨ç½²ç½‘ç»œæ’ä»¶ã€‚


### æ·»åŠ èŠ‚ç‚¹

è®°ä½åˆå§‹åŒ–é›†ç¾¤ä¸Šé¢çš„é…ç½®å’Œæ“ä½œè¦æå‰åšå¥½ï¼Œå°† master èŠ‚ç‚¹ä¸Šé¢çš„ `$HOME/.kube/config` æ–‡ä»¶æ‹·è´åˆ° node èŠ‚ç‚¹å¯¹åº”çš„æ–‡ä»¶ä¸­ï¼ˆå¦‚æœæƒ³åœ¨ node èŠ‚ç‚¹ä¸Šæ“ä½œ kubectlï¼‰ï¼Œå®‰è£… kubeadmã€kubeletã€kubectlï¼ˆå¯é€‰ï¼‰ï¼Œç„¶åæ‰§è¡Œä¸Šé¢åˆå§‹åŒ–å®Œæˆåæç¤ºçš„ join å‘½ä»¤å³å¯ï¼š

```shell
â˜¸ âœ kubeadm join 172.21.0.2:6443 --token abcdef.0123456789abcdef \
        --discovery-token-ca-cert-hash sha256:fc6f8c628bb51ae4cd228aefea957ca0be06188644e8bef992bbb3a9ce40fd5a
[preflight] Running pre-flight checks
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
```

> å¦‚æœå¿˜è®°äº†ä¸Šé¢çš„ join å‘½ä»¤å¯ä»¥ä½¿ç”¨å‘½ä»¤ `kubeadm token create --print-join-command` é‡æ–°è·å–ã€‚


æ‰§è¡ŒæˆåŠŸåè¿è¡Œ get nodes å‘½ä»¤ï¼š

```shell
â˜¸ âœ kubectl get nodes
NAME     STATUS     ROLES           AGE   VERSION
master   NotReady   control-plane   15m   v1.25.4
node1    NotReady   <none>          98s   v1.25.4
```

è¿™ä¸ªæ—¶å€™å…¶å®é›†ç¾¤è¿˜ä¸èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œæ¥ä¸‹æ¥å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œå¯ä»¥åœ¨æ–‡æ¡£ [https://kubernetes.io/docs/concepts/cluster-administration/addons](https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy) ä¸­é€‰æ‹©æˆ‘ä»¬è‡ªå·±çš„ç½‘ç»œæ’ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å®‰è£… flannel:

```shell
â˜¸ âœ wget https://raw.githubusercontent.com/flannel-io/flannel/v0.20.1/Documentation/kube-flannel.yml
# å¦‚æœæœ‰èŠ‚ç‚¹æ˜¯å¤šç½‘å¡ï¼Œåˆ™éœ€è¦åœ¨èµ„æºæ¸…å•æ–‡ä»¶ä¸­æŒ‡å®šå†…ç½‘ç½‘å¡
# æœç´¢åˆ°åä¸º kube-flannel-ds çš„ DaemonSetï¼Œåœ¨kube-flannelå®¹å™¨ä¸‹é¢
â˜¸ âœ vi kube-flannel.yml
......
containers:
- name: kube-flannel
#image: flannelcni/flannel:v0.20.1 for ppc64le and mips64le (dockerhub limitations may apply)
image: docker.io/rancher/mirrored-flannelcni-flannel:v0.20.1
command:
- /opt/bin/flanneld
args:
- --ip-masq
- --kube-subnet-mgr
- --iface=eth0 # å¦‚æœæ˜¯å¤šç½‘å¡çš„è¯ï¼ŒæŒ‡å®šå†…ç½‘ç½‘å¡çš„åç§°
......
â˜¸ âœ kubectl apply -f kube-flannel.yml  # å®‰è£… flannel ç½‘ç»œæ’ä»¶
```

éš”ä¸€ä¼šå„¿æŸ¥çœ‹ Pod è¿è¡ŒçŠ¶æ€ï¼š

```shell
â˜¸ âœ kubectl get pods -A
NAMESPACE      NAME                             READY   STATUS    RESTARTS   AGE
kube-flannel   kube-flannel-ds-9zrh2            1/1     Running   0          12m
kube-flannel   kube-flannel-ds-gxwp5            1/1     Running   0          12m
kube-system    coredns-7b884d5cb7-bfsb8         1/1     Running   0          104s
kube-system    coredns-7b884d5cb7-qmpgn         1/1     Running   0          64s
kube-system    etcd-master                      1/1     Running   1          38m
kube-system    kube-apiserver-master            1/1     Running   1          38m
kube-system    kube-controller-manager-master   1/1     Running   1          38m
kube-system    kube-proxy-bqwpt                 1/1     Running   0          23m
kube-system    kube-proxy-c7z25                 1/1     Running   0          37m
kube-system    kube-proxy-q668d                 1/1     Running   0          15m
kube-system    kube-scheduler-master            1/1     Running   1          38m
```

> å½“æˆ‘ä»¬éƒ¨ç½²å®Œç½‘ç»œæ’ä»¶åæ‰§è¡Œ `ifconfig` å‘½ä»¤ï¼Œæ­£å¸¸ä¼šçœ‹åˆ°æ–°å¢çš„ `cni0` ä¸ `flannel.1` è¿™ä¸¤ä¸ªè™šæ‹Ÿè®¾å¤‡ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰çœ‹åˆ° `cni0` è¿™ä¸ªè®¾å¤‡ä¹Ÿä¸ç”¨å¤ªæ‹…å¿ƒï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿ `/var/lib/cni` ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å¹¶ä¸æ˜¯è¯´éƒ¨ç½²æœ‰é—®é¢˜ï¼Œè€Œæ˜¯è¯¥èŠ‚ç‚¹ä¸Šæš‚æ—¶è¿˜æ²¡æœ‰åº”ç”¨è¿è¡Œï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Pod å°±å¯ä»¥çœ‹åˆ°è¯¥ç›®å½•ä¼šè¢«åˆ›å»ºï¼Œå¹¶ä¸” `cni0` è®¾å¤‡ä¹Ÿä¼šè¢«åˆ›å»ºå‡ºæ¥ã€‚


ç”¨åŒæ ·çš„æ–¹æ³•æ·»åŠ å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹å³å¯ã€‚


### Dashboard

ç›´æ¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ä¸€é”®å®‰è£…å³å¯ï¼š

```shell
# æ¨èä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼
â˜¸ âœ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
â˜¸ âœ vi recommended.yaml
# ä¿®æ”¹Serviceä¸ºNodePortç±»å‹
......
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  ports:
    - port: 443
      targetPort: 8443
  selector:
    k8s-app: kubernetes-dashboard
  type: NodePort  # åŠ ä¸Štype=NodePortå˜æˆNodePortç±»å‹çš„æœåŠ¡
......
```

> åœ¨ YAML æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°æ–°ç‰ˆæœ¬ Dashboard é›†æˆäº†ä¸€ä¸ª `metrics-scraper` çš„ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡ Kubernetes çš„ Metrics API æ”¶é›†ä¸€äº›åŸºç¡€èµ„æºçš„ç›‘æ§ä¿¡æ¯ï¼Œå¹¶åœ¨ web é¡µé¢ä¸Šå±•ç¤ºï¼Œæ‰€ä»¥è¦æƒ³åœ¨é¡µé¢ä¸Šå±•ç¤ºç›‘æ§ä¿¡æ¯å°±éœ€è¦æä¾› Metrics APIï¼Œæ¯”å¦‚å®‰è£… Metrics Serverã€‚


ç›´æ¥åˆ›å»ºï¼š

```shell
â˜¸ âœ kubectl apply -f recommended.yaml
```

æ–°ç‰ˆæœ¬çš„ Dashboard ä¼šè¢«é»˜è®¤å®‰è£…åœ¨ `kubernetes-dashboard` è¿™ä¸ªå‘½åç©ºé—´ä¸‹é¢ï¼š

```shell
â˜¸ âœ kubectl get pods -n kubernetes-dashboard
NAME                                         READY   STATUS    RESTARTS   AGE
dashboard-metrics-scraper-64bcc67c9c-bkphf   1/1     Running   0          2m31s
kubernetes-dashboard-5c8bd6b59-xv84b         1/1     Running   0          2m31s
```

ç„¶åæŸ¥çœ‹ Dashboard çš„ NodePort ç«¯å£ï¼š

```shell
â˜¸ âœ kubectl get svc -n kubernetes-dashboard
NAME                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE
dashboard-metrics-scraper   ClusterIP   10.105.19.9    <none>        8000/TCP        3m23s
kubernetes-dashboard        NodePort    10.101.65.43   <none>        443:31845/TCP   3m23s
```

ç„¶åå¯ä»¥é€šè¿‡ä¸Šé¢çš„ 31845 ç«¯å£å»è®¿é—® Dashboardï¼Œè¦è®°ä½ä½¿ç”¨ httpsï¼ŒChrome ä¸ç”Ÿæ•ˆå¯ä»¥ä½¿ç”¨ `Firefox` æµ‹è¯•ï¼Œå¦‚æœæ²¡æœ‰ Firefox ä¸‹é¢æ‰“ä¸å¼€é¡µé¢ï¼Œå¯ä»¥ç‚¹å‡»ä¸‹é¡µé¢ä¸­çš„ `ä¿¡ä»»è¯ä¹¦`å³å¯ï¼š

![20210831171315.png](./img/KHpWumYNDl6Ild3W/1693878568935-26e71a6a-0dbe-48fd-8808-9501b3931abd-657591.png)

ä¿¡ä»»åå°±å¯ä»¥è®¿é—®åˆ° Dashboard çš„ç™»å½•é¡µé¢äº†ï¼š

![1669868281862.png](./img/KHpWumYNDl6Ild3W/1693878568946-40391b5a-e5b8-4b44-b0a0-d4f860e84845-159738.png)

ç„¶ååˆ›å»ºä¸€ä¸ªå…·æœ‰å…¨å±€æ‰€æœ‰æƒé™çš„ç”¨æˆ·æ¥ç™»å½• Dashboardï¼š

```yaml
# admin.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: admin-user
    namespace: kubernetes-dashboard
```

ç›´æ¥åˆ›å»ºå³å¯ï¼š

```shell
â˜¸ âœ kubectl apply -f admin.yaml
```

ç°åœ¨æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å¯ä»¥ç”¨æ¥ç™»å½•çš„ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨ `kubectl create token` å‘½ä»¤æ¥è¯·æ±‚ä¸€ä¸ª service account tokenï¼š

```bash
# è¯·æ±‚åˆ›å»ºä¸€ä¸ª token ä½œä¸º kubernetes-dashboard å‘½åç©ºé—´ä¸­çš„ admin-user è¿™ä¸ª sa å¯¹ kube-apiserver è¿›è¡Œèº«ä»½éªŒè¯
â˜¸ âœ kubectl -n kubernetes-dashboard create token admin-user
```

ä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œåä¼šæ‰“å°å‡ºå¦‚ä¸‹æ‰€ç¤ºçš„ tokenï¼š

```bash
eyJhbGciOiJSUzI1NiIsImtpZCI6ImZEWFJ5NU1EV0FhcWlsLWVKRnNoMlQ3bDg0d2RWU0hnWTlSUmVockZYM2MifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjY5ODcyOTU5LCJpYXQiOjE2Njk4NjkzNTksImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib......
```

ç„¶åç”¨ä¸Šé¢çš„å­—ç¬¦ä¸²ä½œä¸º token ç™»å½• Dashboard å³å¯ï¼š

![1669869736598.png](./img/KHpWumYNDl6Ild3W/1693878569094-6622754f-b515-49f2-a3cb-bc0d2610d1ab-445581.png)

åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†ä½¿ç”¨ kubeadm æ­å»º v1.25.4 ç‰ˆæœ¬çš„ kubernetes é›†ç¾¤ã€‚


### æ¸…ç†

å¦‚æœä½ çš„é›†ç¾¤å®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°äº†å…¶ä»–é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥è¿›è¡Œé‡ç½®ï¼š

```shell
â˜¸ âœ kubeadm reset
â˜¸ âœ ifconfig cni0 down && ip link delete cni0
â˜¸ âœ ifconfig flannel.1 down && ip link delete flannel.1
â˜¸ âœ rm -rf /var/lib/cni/
```


## Kind

![1669870070082.jpg](./img/KHpWumYNDl6Ild3W/1693878569110-d1d339e4-707f-446b-b9b1-3ff8f7bf52ee-390479.jpeg)

[Kind](https://kind.sigs.k8s.io) æ˜¯ `Kubernetes in Docker` çš„ç®€å†™ï¼Œæ˜¯ä¸€ä¸ªä½¿ç”¨ Docker å®¹å™¨ä½œä¸º Node èŠ‚ç‚¹ï¼Œåœ¨æœ¬åœ°åˆ›å»ºå’Œè¿è¡Œ Kubernetes é›†ç¾¤çš„å·¥å…·ã€‚é€‚ç”¨äºåœ¨æœ¬æœºåˆ›å»º Kubernetes é›†ç¾¤ç¯å¢ƒè¿›è¡Œå¼€å‘å’Œæµ‹è¯•ã€‚ä½¿ç”¨ Kind æ­å»ºçš„é›†ç¾¤æ— æ³•åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœä½ åªæ˜¯æƒ³åœ¨æœ¬åœ°ç®€å•çš„ç©ç© K8sï¼Œä¸æƒ³å ç”¨å¤ªå¤šçš„èµ„æºï¼Œé‚£ä¹ˆä½¿ç”¨ Kind æ˜¯ä½ ä¸é”™çš„é€‰æ‹©ã€‚

Kind å†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨ Kubeadm åˆ›å»ºå’Œå¯åŠ¨é›†ç¾¤èŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨ Containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥å¼ƒç”¨ `dockershim` å¯¹ Kind æ²¡æœ‰ä»€ä¹ˆå½±å“ã€‚

Kind çš„æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œå®ƒå°† Docker å®¹å™¨ä½œä¸º Kubernetes çš„ Node èŠ‚ç‚¹ï¼Œå¹¶åœ¨è¯¥ Node ä¸­å®‰è£… Kubernetes ç»„ä»¶ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæˆ–è€…å¤šä¸ª Control Plane å’Œä¸€ä¸ªæˆ–è€…å¤šä¸ª Work Nodesã€‚è¿™å°±è§£å†³äº†åœ¨æœ¬æœºè¿è¡Œå¤šä¸ª Node çš„é—®é¢˜ï¼Œè€Œä¸éœ€è¦è™šæ‹ŸåŒ–ã€‚

![1669870050130.jpg](./img/KHpWumYNDl6Ild3W/1693878569211-64e6ae5d-a91b-4b3e-8719-86f2293cff97-668367.jpeg)


### å®‰è£…

è¦ä½¿ç”¨ Kind çš„å‰ææ˜¯æä¾›ä¸€ä¸ª Docker ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¿«é€Ÿå®‰è£…ã€‚

```bash
sudo sh -c "$(curl -fsSL https://get.docker.com)"
```

å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨æ¡Œé¢ç‰ˆï¼Œæ¯”å¦‚æˆ‘æœ¬åœ°æ˜¯ Mac m1 ç¯å¢ƒï¼Œå®‰è£…äº† Docker Desktop ç‰ˆæœ¬ã€‚

![1669876043952.png](./img/KHpWumYNDl6Ild3W/1693878569226-4c536b03-f689-4f6c-a842-f7a9e69f7664-825275.png)

Docker å®‰è£…è¿‡åæ¥ä¸‹æ¥å¯ä»¥å®‰è£…ä¸€ä¸ª kubectl å·¥å…·ï¼ŒKind æœ¬èº«ä¸éœ€è¦ kubectlï¼Œå®‰è£… kubectl å¯ä»¥åœ¨æœ¬æœºç›´æ¥ç®¡ç† Kubernetes é›†ç¾¤ã€‚

**Linux ç³»ç»Ÿ**

```bash
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
#éªŒè¯ç‰ˆæœ¬
kubectl version --client
```

**MacOS ç³»ç»Ÿ**

```bash
brew install kubectl
#éªŒè¯ç‰ˆæœ¬
kubectl version --client
```

æ¥ä¸‹æ¥å°±å¯ä»¥å®‰è£… Kind äº†ï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯åœ¨ [Github Release é¡µé¢](https://github.com/kubernetes-sigs/kind/releases) ç›´æ¥ä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…å³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œå®‰è£…æœ€æ–°çš„ `v0.17.0` ç‰ˆæœ¬ï¼š

```bash
â˜¸ âœ wget https://github.com/kubernetes-sigs/kind/releases/download/v0.17.0/kind-darwin-amd64
# å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åŠ é€Ÿ
# wget https://ghps.cc/https://github.com/kubernetes-sigs/kind/releases/download/v0.17.0/kind-darwin-amd64
â˜¸ âœ chmod +x kind-darwin-amd64
â˜¸ âœ sudo mv kind-darwin-amd64 /usr/local/bin/kind
# éªŒè¯ç‰ˆæœ¬
â˜¸ âœ kind version
kind v0.17.0 go1.19.2 darwin/amd64
```

å¯¹äº Mac ç³»ç»Ÿä¹Ÿå¯ä»¥ä½¿ç”¨ `brew install kind` è¿›è¡Œä¸€é”®å®‰è£…ã€‚


### æ“ä½œ

è¦äº†è§£ Kind çš„æ“ä½œï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ç›´æ¥æ‰§è¡Œä¸€æ¡ `kind` å‘½ä»¤ï¼Œæˆ–è€… `kind -h`ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬äº†è§£ä»»ä½• CLI å·¥å…·æœ€åŸºç¡€çš„æ–¹æ³•ï¼š

```bash
â˜¸ âœ kind
kind creates and manages local Kubernetes clusters using Docker container 'nodes'

Usage:
  kind [command]

Available Commands:
  build       Build one of [node-image]
  completion  Output shell completion code for the specified shell (bash, zsh or fish)
  create      Creates one of [cluster]
  delete      Deletes one of [cluster]
  export      Exports one of [kubeconfig, logs]
  get         Gets one of [clusters, nodes, kubeconfig]
  help        Help about any command
  load        Loads images into nodes
  version     Prints the kind CLI version

Flags:
  -h, --help              help for kind
      --loglevel string   DEPRECATED: see -v instead
  -q, --quiet             silence all stderr output
  -v, --verbosity int32   info log verbosity, higher value produces more output
      --version           version for kind

Use "kind [command] --help" for more information about a command.
```

ä»ä¸Šé¢çš„å‘½ä»¤å¯ä»¥çœ‹å‡º kind å·¥å…·åŒ…å«å¾ˆå¤šå¯ç”¨çš„å‘½ä»¤ï¼Œæ¯”å¦‚ `build`ã€`create`ã€`delete`ã€`load` ç­‰ç­‰ï¼Œå…¶ä¸­æœ€é‡è¦çš„åº”è¯¥å±äº `create` å‘½ä»¤äº†ï¼Œè¯¥å‘½ä»¤å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œç”¨åŒæ ·çš„æ–¹å¼æˆ‘ä»¬å¯ä»¥ç»§ç»­æŸ¥çœ‹ `kind create` å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ï¼š

```bash
â˜¸ âœ kind create -h
Creates one of local Kubernetes cluster (cluster)

Usage:
  kind create [flags]
  kind create [command]

Available Commands:
  cluster     Creates a local Kubernetes cluster

Flags:
  -h, --help   help for create

Global Flags:
      --loglevel string   DEPRECATED: see -v instead
  -q, --quiet             silence all stderr output
  -v, --verbosity int32   info log verbosity, higher value produces more output

Use "kind create [command] --help" for more information about a command.
```

å¯ä»¥çœ‹å‡ºåªæœ‰ä¸€ä¸ª `cluster` å­å‘½ä»¤å¯ç”¨ï¼Œä½†æ˜¯è¯¥å­å‘½ä»¤åé¢å¦‚ä½•æ“ä½œå‘¢ï¼Ÿ

```bash
â˜¸ âœ kind create cluster -h
Creates a local Kubernetes cluster using Docker container 'nodes'

Usage:
  kind create cluster [flags]

Flags:
      --config string       path to a kind config file
  -h, --help                help for cluster
      --image string        node docker image to use for booting the cluster
      --kubeconfig string   sets kubeconfig path instead of $KUBECONFIG or $HOME/.kube/config
  -n, --name string         cluster name, overrides KIND_CLUSTER_NAME, config (default kind)
      --retain              retain nodes for debugging when cluster creation fails
      --wait duration       wait for control plane node to be ready (default 0s)

Global Flags:
      --loglevel string   DEPRECATED: see -v instead
  -q, --quiet             silence all stderr output
  -v, --verbosity int32   info log verbosity, higher value produces more output
```

å¯ä»¥çœ‹åˆ° `create cluster` åé¢æ²¡æœ‰å¯ç”¨çš„å­å‘½ä»¤äº†ï¼Œä½†æ˜¯æœ‰ä¸€äº› `Flags` æ ‡å¿—å¯ä»¥ä¼ é€’ï¼Œä½†å…¶å®ä¸ä¼ é€’ä»»ä½•çš„å‚æ•°ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ª K8s é›†ç¾¤ï¼Œè¿™å±äºæœ€ç®€å•åˆ›å»º K8s çš„æ–¹å¼ï¼Œåªéœ€è¦æ‰§è¡Œå¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤å³å¯åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„é›†ç¾¤ï¼ˆç›®å‰æœ€æ–°ç‰ˆæœ¬åªæ”¯æŒåˆ° K8s `v1.25.3` ç‰ˆæœ¬ï¼‰ï¼š

```bash
â˜¸ âœ kind create cluster
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.25.3) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Thanks for using kind! ğŸ˜Š
```

åˆ›å»ºå®Œæˆåå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤ç®¡ç†è¯¥ K8s é›†ç¾¤äº†ï¼š

```bash
â˜¸ âœ kubectl get nodes
NAME                 STATUS   ROLES           AGE   VERSION
kind-control-plane   Ready    control-plane   88s   v1.25.3
â˜¸ âœ kubectl get pods -A
NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
kube-system          coredns-565d847f94-vfxg9                     1/1     Running   0          2m4s
kube-system          coredns-565d847f94-whgsv                     1/1     Running   0          2m4s
kube-system          etcd-kind-control-plane                      1/1     Running   0          2m18s
kube-system          kindnet-lp8kf                                1/1     Running   0          2m4s
kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          2m19s
kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          2m18s
kube-system          kube-proxy-mv86p                             1/1     Running   0          2m4s
kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          2m18s
local-path-storage   local-path-provisioner-684f458cdd-4f999      1/1     Running   0          2m4s
```

é»˜è®¤çš„é›†ç¾¤åç§°ä¸º `kind`ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•° `--name` æŒ‡å®šåˆ›å»ºçš„é›†ç¾¤åç§°ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªç¾¤é›†ï¼š

```bash
â˜¸ âœ kind create cluster --name kind-2
```

æ­¤å¤–è¿˜å¯ä»¥æŒ‡å®šå¯åŠ¨é›†ç¾¤çš„ Node é•œåƒï¼š

```bash
â˜¸ âœ kind create cluster --name kind-3 --image kindest/node:v1.23.4
```

ç„¶åå¯ä»¥ä½¿ç”¨ `kind get clusters` å‘½ä»¤æ¥è·å–é›†ç¾¤åˆ—è¡¨ï¼š

```bash
â˜¸ âœ kind get clusters
kind
kind-2
kind-3
```

å½“æœ‰å¤šä¸ªé›†ç¾¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubectl æ¥åˆ‡æ¢è¦ç®¡ç†çš„é›†ç¾¤ï¼š

```bash
# åˆ‡æ¢åˆ°é›†ç¾¤ `kind`
â˜¸ âœ kubectl config use-context kind-kind

# åˆ‡æ¢åˆ°ç¾¤é›†`kind-2`
â˜¸ âœ kubectl config use-context kind-kind-2
```

è¦åˆ é™¤é›†ç¾¤ä¹Ÿéå¸¸ç®€å•ï¼Œæ¯”å¦‚è¦åˆ é™¤ kind-2 é›†ç¾¤ï¼š

```bash
â˜¸ âœ kind delete cluster --name kind-2
```

Kind é›†ç¾¤ä¸­çš„ Docker é•œåƒå¯ä»¥ä»äº’è”ç½‘ç›´æ¥æ‹‰å–ï¼Œæœ‰æ—¶å€™å¯èƒ½æ¯”è¾ƒç¼“æ…¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†æœ¬æœºé•œåƒå¯¼å…¥åˆ° Kind é›†ç¾¤ä¸­å»ï¼Œæ¯”å¦‚ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯ä»¥å°†é•œåƒå¯¼å…¥åˆ° `kind-control-plane` èŠ‚ç‚¹å»ï¼š

```bash
â˜¸ âœ kind load docker-image --nodes kind-control-plane nginx:mainline-alpine
Image: "" with ID "sha256:e08a7adafd859e875957b027d89dfcbbe8cce7a5525ad88460c23a91febbfdac" not yet present on node "kind-control-plane", loading...
```


### é…ç½®é›†ç¾¤

ä¸Šé¢æˆ‘ä»¬ä»‹ç»çš„æ˜¯ kind å‘½ä»¤çš„ä¸€äº›å¸¸ç”¨æ“ä½œï¼Œæ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸€ä¸ªæ–‡ä»¶æ¥é…ç½®è¦åˆ›å»ºçš„ K8s é›†ç¾¤ï¼Œæ¯”å¦‚å®šä¹‰ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ `config.yaml` æ–‡ä»¶ï¼š

```yaml
# config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: demo
nodes:
  - role: control-plane
  - role: worker
  - role: worker
```

è¯¥é…ç½®æ–‡ä»¶è¡¨ç¤ºæˆ‘ä»¬ä¸€å…±è¦åˆ›å»º 3 ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªæ§åˆ¶èŠ‚ç‚¹ï¼Œä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼Œåœ¨åˆ›å»ºé›†ç¾¤çš„æ—¶å€™åªéœ€è¦é€šè¿‡ `--config` å‚æ•°æŒ‡å®šè¯¥æ–‡ä»¶å³å¯ï¼š

```bash
â˜¸ âœ kind create cluster --config config.yaml
```

åˆ›å»ºåçš„é›†ç¾¤åç§°ä¸º `demo`ï¼Œä¸€å…±åŒ…æ‹¬ 3 ä¸ªèŠ‚ç‚¹ï¼š

```bash
â˜¸ âœ kubectl get nodes
NAME                 STATUS   ROLES           AGE   VERSION
demo-control-plane   Ready    control-plane   32s   v1.25.3
demo-worker          Ready    <none>          12s   v1.25.3
demo-worker2         Ready    <none>          13s   v1.25.3
```

å¦‚æœæƒ³åˆ›å»ºä¸€ä¸ª HA æ¨¡å¼çš„æ§åˆ¶å¹³é¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºçš„é…ç½®æ–‡ä»¶ï¼Œåªéœ€è¦æŒ‡å®š 3 ä¸ª(å¥‡æ•°ä¸ª) `control-plane` è§’è‰²çš„èŠ‚ç‚¹å³å¯ï¼š

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: control-plane
  - role: control-plane
  - role: worker
  - role: worker
  - role: worker
```

æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥å°† Node çš„ç«¯å£æ˜ å°„åˆ°å®¿ä¸»ä¸»ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ `extraPortMappings` å±æ€§å¯ä»¥å®ç°è¯¥åŠŸèƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºé…ç½®å¯ä»¥å°† `control-plane` èŠ‚ç‚¹ 80 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 80 ç«¯å£ä¸Šï¼š

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    extraPortMappings:
      - containerPort: 80
        hostPort: 80
        listenAddress: "0.0.0.0" # Optional, defaults to "0.0.0.0"
        protocol: udp # Optional, defaults to tcp
```

å¦‚æœè¦å°†ç«¯å£æ˜ å°„ä¸ NodePort ä¸€èµ·ä½¿ç”¨ï¼Œkind èŠ‚ç‚¹çš„ containerPort å’Œ Service çš„ nodePort éœ€è¦ç›¸ç­‰ã€‚

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    extraPortMappings:
      - containerPort: 30950
        hostPort: 80
```

ç„¶åå°† `nodePort` è®¾ç½®ä¸º 30950ã€‚

```yaml
kind: Pod
apiVersion: v1
metadata:
  name: foo
  labels:
    app: foo
spec:
  containers:
    - name: foo
      image: hashicorp/http-echo:0.2.3
      args:
        - "-text=foo"
      ports:
        - containerPort: 5678
---
apiVersion: v1
kind: Service
metadata:
  name: foo
spec:
  type: NodePort
  ports:
    - name: http
      nodePort: 30950
      port: 5678
  selector:
    app: foo
```

åŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š Node çš„å®¹å™¨é•œåƒç‰ˆæœ¬è¿è¡ŒæŒ‡å®šç‰ˆæœ¬çš„ Kubernetes ç¾¤é›†ã€‚å¯ä»¥åœ¨[å®˜æ–¹ release é¡µé¢](https://github.com/kubernetes-sigs/kind/releases)ä¸­ä¸­æŸ¥æ‰¾éœ€è¦é•œåƒ tagï¼Œå¸¦ä¸Š sha256 shasumï¼ˆéå¿…é¡»ï¼‰ï¼Œä¾‹å¦‚ï¼š

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    image: kindest/node:v1.18.15@sha256:5c1b980c4d0e0e8e7eb9f36f7df525d079a96169c8a8f20d8bd108c0d0889cc4
  - role: worker
    image: kindest/node:v1.18.15@sha256:5c1b980c4d0e0e8e7eb9f36f7df525d079a96169c8a8f20d8bd108c0d0889cc4
```

æ­¤å¤–è¿˜æœ‰ä¸€äº›å…¶ä»–å®šåˆ¶æ“ä½œï¼Œæ¯”å¦‚ Kind åˆ›å»ºçš„é›†ç¾¤é»˜è®¤è‡ªå¸¦ä¸€ä¸ªè½»é‡çº§çš„ CNI æ’ä»¶ `kindnetd`ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç¦ç”¨é»˜è®¤è®¾ç½®æ¥å®‰è£…å…¶ä»– CNIï¼Œæ¯”å¦‚ Calicoã€‚

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  # the default CNI will not be installed
  disableDefaultCNI: true
```

è¿˜å¯ä»¥åœ¨ iptables å’Œ ipvs ä¹‹é—´é…ç½®å°†è¦ä½¿ç”¨çš„ kube-proxy æ¨¡å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ `iptables`ï¼š

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  kubeProxyMode: "ipvs"
```

å¦å¤–æˆ‘ä»¬å¯ä»¥è®²å®¿ä¸»æœºçš„è·¯å¾„æŒ‚è½½åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šç”¨äºæ•°æ®æŒä¹…åŒ–ç­‰ã€‚

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    # add a mount from /path/to/my/files on the host to /files on the node
    extraMounts:
      - hostPath: /path/to/my/files
        containerPath: /files
```

æˆ‘ä»¬è¿˜å¯ä»¥ç»™èŠ‚ç‚¹å®šåˆ¶ä¸åŒçš„æ ‡ç­¾ï¼Œè¿™å¯¹äºèŠ‚ç‚¹ç­›é€‰éå¸¸æœ‰ç”¨ï¼Œåªéœ€è¦åœ¨èŠ‚ç‚¹ä¸­æ·»åŠ  `labels` é…ç½®å³å¯ã€‚

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
    extraPortMappings:
      - containerPort: 30950
        hostPort: 80
    labels:
      tier: frontend
  - role: worker
    labels:
      tier: backend
```

Kind ä½¿ç”¨ Kubeadm æ¥é…ç½®çš„é›†ç¾¤èŠ‚ç‚¹ï¼Œä»–ä¼šåœ¨ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œ `kubeadm init` å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubeadm InitConfiguration æ¥è¿›è¡Œä¸€äº›å®šåˆ¶ã€‚

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "my-label=true"
```

å¦‚æœä½ æƒ³è¿›è¡Œæ›´å¤šçš„å®šåˆ¶ï¼Œé‚£ä¹ˆåœ¨ `kubeadm init` æœŸé—´æœ‰å››ç§é…ç½®ç±»å‹å¯ç”¨: `InitConfiguration`ã€ `ClusterConfiguration`ã€ `KubeProxyConfiguration`ã€ `KubeletConfiguration`ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubeadm ClusterConfiguration æ¥è¦†ç›– apiserver æ ‡å¿—:

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: ClusterConfiguration
        apiServer:
            extraArgs:
              enable-admission-plugins: NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook
```

åœ¨ Kind é›†ç¾¤ä¸­çš„ worker æˆ–æ§åˆ¶å¹³é¢(åœ¨ HA æ¨¡å¼ä¸‹)èŠ‚ç‚¹ä¸Šï¼ŒKind ä¼šæ‰§è¡Œ `kubeadm join` å‘½ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ JoinConfiguration (spec) æ¥è¿›è¡Œå®šåˆ¶ï¼š

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
  - role: worker
    kubeadmConfigPatches:
      - |
        kind: JoinConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "my-label2=true"
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: JoinConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "my-label3=true"
```

æ­¤å¤– Kind è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å®è·µæ–¹å¼ï¼Œåœ¨åç»­è¯¾ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿä¼šæ…¢æ…¢æ¥è§¦åˆ°ã€‚


> åŸæ–‡: <https://www.yuque.com/cnych/k8s4/yrgiiy54yc1cefx9>